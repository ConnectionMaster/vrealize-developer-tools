name: Publish Release
on:
  release:
    types: [released]
jobs:
  publish:
    name: Publish to Visual Studio Marketplace and GitHub Packages
    runs-on: macos-latest
    steps:
      - name: Use Node.js 16.x
        uses: actions/setup-node@v2
        with:
          node-version: 16.x

      - name: Install vsce
        run: npm install -g vsce

      - name: Install sha256sum and minisign
        run: |
          brew update
          brew install coreutils minisign

      - name: Download release assets
        id: release_asset
        env:
          TAG_NAME: ${{ github.event.release.tag_name }}
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
        run: gh release download $TAG_NAME

      - name: Verify checksum signatures
        run: |
          minisign -Vm vrealize-developer-tools-${TAG_NAME#v}.vsix.sha256 -P "RWSLXIQU0b52vHvyFK7d0SQmt3he8hrZnBzwp/e30XALf4rtRc0Cluhh"
          minisign -Vm packages.sha256 -P "RWSLXIQU0b52vHvyFK7d0SQmt3he8hrZnBzwp/e30XALf4rtRc0Cluhh"
        env:
          TAG_NAME: ${{ github.event.release.tag_name }}

      - name: Verify checksums of all release assets
        env:
          TAG_NAME: ${{ github.event.release.tag_name }}
        run: |
          sha256sum -c vrealize-developer-tools-${TAG_NAME#v}.vsix.sha256
          sha256sum -c packages.sha256

      - name: Publish extension to VS Marketplace
        env:
          TAG_NAME: ${{ github.event.release.tag_name }}
          MARKETPLACE_SECRET: ${{ secrets.VS_MARKETPLACE_TOKEN }}
        run: "vsce publish -p $MARKETPLACE_SECRET --packagePath vrealize-developer-tools-${TAG_NAME#v}.vsix"

      - name: Publish npm packages to GitHub Packages Registry
        env:
          TAG_NAME: ${{ github.event.release.tag_name }}
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: | # uses the package.json's publishConfig/registry URL
          find *.tgz -type f -exec npm publish {} \;
